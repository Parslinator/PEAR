<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEAR - College Football Power Ratings</title>
    <!-- External libraries for parsing data files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 50%;
            border: 3px solid #4ecdc4;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50px;
            padding: 5px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #fff;
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            margin: 2px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Tables */
        .data-table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0,0,0,0.2);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr:hover {
            background: rgba(78, 205, 196, 0.1);
        }

        /* Forms and Interactive Elements */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #4ecdc4; }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 1rem;
        }
        select option { background: #1a1a2e; color: #fff; }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        /* Layout */
        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        /* Utility Classes */
        .caption { font-size: 0.9rem; opacity: 0.7; margin-top: 10px; text-align: center; }
        .loading, .error { text-align: center; padding: 50px; font-size: 1.1rem; }
        .error { background: rgba(255, 107, 107, 0.2); border-left: 4px solid #ff6b6b; border-radius: 8px; margin: 20px 0; }
        .visual-image { max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            .nav-tabs { flex-direction: column; align-items: stretch; border-radius: 15px; }
            .tab-btn { margin: 2px 5px; text-align: center; }
            th, td { padding: 8px 5px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <img src="PEAR/pear_logo.jpg" alt="PEAR Logo" class="logo" onerror="this.style.display='none'">
            <h1>PEAR</h1>
            <p class="subtitle" id="weekDisplay">College Football Power Ratings</p>
        </header>
        
        <!-- Global Error Message Container -->
        <div id="globalErrorContainer"></div>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="power-ratings">Power Ratings</button>
            <button class="tab-btn" data-tab="spreads">Spreads</button>
            <button class="tab-btn" data-tab="visuals">Visuals</button>
            <button class="tab-btn" data-tab="calculator">Calculator</button>
            <button class="tab-btn" data-tab="archive">Archive</button>
        </nav>

        <!-- Power Ratings Tab -->
        <main id="power-ratings" class="tab-content active">
            <div class="card">
                <input type="text" id="teamSearch" placeholder="Search teams..." aria-label="Search teams">
            </div>
            <div class="data-table-container">
                <div id="ratingsLoading" class="loading">Loading ratings data...</div>
                <table id="ratingsTable" style="display: none;">
                    <thead><tr id="ratingsHeader"></tr></thead>
                    <tbody id="ratingsBody"></tbody>
                </table>
            </div>
            <p class="caption">MD: Most Deserving | SOS: Strength of Schedule | SOR: Strength of Record | ST: Special Teams | PBR: Pass Blocking | DCE: Def. Carry Eff. | DDE: Def. Dropback Eff.</p>
        </main>

        <!-- Spreads Tab -->
        <main id="spreads" class="tab-content">
            <h2 id="spreadsTitle" class="subtitle" style="text-align: center; margin-bottom: 20px;">Weekly Spreads</h2>
            <div class="data-table-container">
                <div id="spreadsLoading" class="loading">Loading spreads data...</div>
                <table id="spreadsTable" style="display: none;">
                    <thead><tr id="spreadsHeader"></tr></thead>
                    <tbody id="spreadsBody"></tbody>
                </table>
            </div>
            <p class="caption">GQI: Game Quality Index (Entertainment Value)</p>
        </main>

        <!-- Visuals Tab -->
        <main id="visuals" class="tab-content">
            <div class="two-column">
                <div class="card">
                    <h3>Game Images</h3>
                    <div class="form-group">
                        <label for="gameSelect">Select a Game:</label>
                        <select id="gameSelect"><option value="">Loading games...</option></select>
                    </div>
                    <div id="gameImageContainer"></div>
                </div>
                <div class="card">
                    <h3>Stat Profiles</h3>
                    <div class="form-group">
                        <label for="profileSelect">Select a Stat Profile:</label>
                        <select id="profileSelect"><option value="">Loading profiles...</option></select>
                    </div>
                    <div id="profileImageContainer"></div>
                </div>
            </div>
        </main>

        <!-- Calculator Tab -->
        <main id="calculator" class="tab-content">
            <div class="two-column">
                <div class="card">
                    <h2>Spread Calculator</h2>
                    <form id="spreadForm">
                        <div class="form-group"><label for="awayTeam">Away Team</label><select id="awayTeam" required><option value="">Loading...</option></select></div>
                        <div class="form-group"><label for="homeTeam">Home Team</label><select id="homeTeam" required><option value="">Loading...</option></select></div>
                        <div class="form-group"><label for="neutralField">Location</label><select id="neutralField"><option value="false">On Campus</option><option value="true">Neutral Field</option></select></div>
                        <button type="submit" class="btn">Calculate Spread</button>
                    </form>
                    <div id="spreadResult" class="result" style="display: none;"></div>
                </div>
                <div class="card">
                    <h2>Win Probability</h2>
                    <form id="probForm">
                        <div class="form-group"><label for="probTeam1">Team 1 (Home)</label><select id="probTeam1" required><option value="">Loading...</option></select></div>
                        <div class="form-group"><label for="probTeam2">Team 2 (Away)</label><select id="probTeam2" required><option value="">Loading...</option></select></div>
                        <button type="submit" class="btn">Calculate</button>
                    </form>
                    <div id="probResult" class="result" style="display: none;"></div>
                </div>
            </div>
        </main>

        <!-- Archive Tab -->
        <main id="archive" class="tab-content">
            <div class="two-column">
                <div class="card data-table-container">
                    <h3>Team Data Overview</h3>
                    <div id="archiveLoading" class="loading">Loading historical data...</div>
                    <table id="archiveTable" style="display: none;">
                        <thead><tr id="archiveHeader"></tr></thead>
                        <tbody id="archiveBody"></tbody>
                    </table>
                </div>
                <div class="card">
                    <h3>Team History</h3>
                    <form id="teamHistoryForm">
                        <div class="form-group"><label for="historyTeam">Select Team</label><select id="historyTeam" required><option value="">Loading...</option></select></div>
                        <button type="submit" class="btn">View History</button>
                    </form>
                    <div id="historyResult" class="result" style="display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Main application logic is encapsulated in an object to avoid polluting the global scope.
        const App = {
            // Store data and configuration here
            data: {
                ratings: [],
                spreads: [],
                teamData: [],
                teamsList: []
            },
            config: {
                year: 2025,
                week: 5,
                hfa: 3 // Home Field Advantage
            },

            // --- INITIALIZATION ---
            init() {
                this.addEventListeners();
                this.loadAllData();
                this.updateStaticUI();
            },

            addEventListeners() {
                // Tab navigation
                document.querySelector('.nav-tabs').addEventListener('click', this.handleTabClick.bind(this));
                
                // Interactive elements
                document.getElementById('teamSearch').addEventListener('keyup', this.handleTeamSearch.bind(this));
                document.getElementById('spreadForm').addEventListener('submit', this.handleSpreadCalculation.bind(this));
                document.getElementById('probForm').addEventListener('submit', this.handleProbabilityCalculation.bind(this));
                document.getElementById('teamHistoryForm').addEventListener('submit', this.handleHistorySearch.bind(this));

                // Visuals selectors
                document.getElementById('gameSelect').addEventListener('change', this.displayGameImage.bind(this));
                document.getElementById('profileSelect').addEventListener('change', this.displayStatProfile.bind(this));
            },
            
            updateStaticUI() {
                const { week, year } = this.config;
                document.getElementById('weekDisplay').textContent = `Week ${week} â€¢ ${year} Season`;
                document.getElementById('spreadsTitle').textContent = `Week ${week} Spreads`;
            },
            
            // --- DATA LOADING ---
            async fetchFile(path, type = 'csv') {
                try {
                    const response = await fetch(path);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${path}. Status: ${response.status}`);
                    }
                    if (type === 'csv') {
                        const csvText = await response.text();
                        return Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
                    } else if (type === 'xlsx') {
                        const buffer = await response.arrayBuffer();
                        const workbook = XLSX.read(buffer, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        return XLSX.utils.sheet_to_json(sheet);
                    }
                } catch (error) {
                    console.error(error);
                    this.showError(`Could not load data from ${path}. Check the file path and that you are running a local server.`);
                    return null; // Return null on failure
                }
            },
            
            async loadAllData() {
                const { year, week } = this.config;
                const ratingsPath = `PEAR/PEAR Football/y${year}/Ratings/PEAR_week${week}.csv`;
                const spreadsPath = `PEAR/PEAR Football/y${year}/Spreads/spreads_tracker_week${week}.xlsx`;
                const teamDataPath = `PEAR/PEAR Football/y${year}/Data/team_data_week${week}.csv`;

                const [ratings, spreads, teamData] = await Promise.all([
                    this.fetchFile(ratingsPath, 'csv'),
                    this.fetchFile(spreadsPath, 'xlsx'),
                    this.fetchFile(teamDataPath, 'csv')
                ]);

                // Process ratings data
                if (ratings) {
                    this.data.ratings = ratings;
                    this.data.teamsList = ratings.map(row => row.team).filter(Boolean).sort();
                    this.renderRatingsTable();
                    this.populateTeamSelectors();
                }
                this.toggleLoading('ratingsLoading', false);

                // Process spreads data
                if (spreads) {
                    this.data.spreads = spreads;
                    this.renderSpreadsTable();
                }
                this.toggleLoading('spreadsLoading', false);
                
                // Process archive data
                if (teamData) {
                    this.data.teamData = teamData;
                    this.renderArchiveTable();
                }
                this.toggleLoading('archiveLoading', false);
                
                this.setupVisuals();
            },

            // --- RENDERING ---
            renderRatingsTable(filteredData = this.data.ratings) {
                const table = document.getElementById('ratingsTable');
                const header = document.getElementById('ratingsHeader');
                const body = document.getElementById('ratingsBody');
                
                if (filteredData.length === 0) {
                    table.style.display = 'none';
                    return;
                }
                
                header.innerHTML = `<th>Rank</th><th>Team</th><th>Rating</th><th>MD</th><th>SOS</th><th>SOR</th><th>OFF</th><th>DEF</th><th>ST</th><th>PBR</th><th>DCE</th><th>DDE</th><th>CONF</th>`;
                body.innerHTML = filteredData.map((row, index) => {
                    // Helper to safely parse integer ranks from CSV strings
                    const parseRank = (value) => {
                        if (value === null || value === undefined || value === '') return '-';
                        const num = parseInt(value, 10);
                        return isNaN(num) ? '-' : num;
                    };

                    return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${row.team || '-'}</td>
                        <td>${parseFloat(row.power_rating || 0).toFixed(1)}</td>
                        <td>${parseRank(row.most_deserving)}</td>
                        <td>${parseRank(row.SOS)}</td>
                        <td>${parseRank(row.SOR)}</td>
                        <td>${parseRank(row.Offense)}</td>
                        <td>${parseRank(row.Defense)}</td>
                        <td>${parseRank(row.STM_rank)}</td>
                        <td>${parseRank(row.PBR_rank)}</td>
                        <td>${parseRank(row.DCE_rank)}</td>
                        <td>${parseRank(row.DDE_rank)}</td>
                        <td>${row.conference || '-'}</td>
                    </tr>
                    `;
                }).join('');
                table.style.display = 'table';
            },

            renderSpreadsTable() {
                const table = document.getElementById('spreadsTable');
                const header = document.getElementById('spreadsHeader');
                const body = document.getElementById('spreadsBody');
                
                header.innerHTML = `<th>Home</th><th>Away</th><th>PEAR</th><th>Vegas</th><th>Diff</th><th>GQI</th>`;
                body.innerHTML = this.data.spreads.filter(row => row.home_team).map(row => `
                    <tr>
                        <td>${row.home_team || ''}</td>
                        <td>${row.away_team || ''}</td>
                        <td>${row.PEAR || ''}</td>
                        <td>${row.Vegas || row.formattedSpread || ''}</td>
                        <td>${parseFloat(row.difference || 0).toFixed(1)}</td>
                        <td>${parseFloat(row.GQI || row.game_quality || 0).toFixed(1)}</td>
                    </tr>
                `).join('');
                table.style.display = 'table';
            },
            
            renderArchiveTable() {
                const table = document.getElementById('archiveTable');
                const header = document.getElementById('archiveHeader');
                const body = document.getElementById('archiveBody');
                const sampleRow = this.data.teamData[0];
                if (!sampleRow) return;

                const headers = Object.keys(sampleRow).slice(0, 8);
                header.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
                body.innerHTML = this.data.teamData.slice(0, 50).map(row => `
                    <tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>
                `).join('');
                table.style.display = 'table';
            },

            populateTeamSelectors() {
                const options = `<option value="">Select Team</option>` + this.data.teamsList.map(team => `<option value="${team}">${team}</option>`).join('');
                ['awayTeam', 'homeTeam', 'probTeam1', 'probTeam2', 'historyTeam'].forEach(id => {
                    document.getElementById(id).innerHTML = options;
                });
            },

            // --- EVENT HANDLERS ---
            handleTabClick(event) {
                if (!event.target.matches('.tab-btn')) return;
                
                const tabName = event.target.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
            },

            handleTeamSearch(event) {
                const searchTerm = event.target.value.toLowerCase();
                const filtered = this.data.ratings.filter(row => (row.team || '').toLowerCase().includes(searchTerm));
                this.renderRatingsTable(filtered);
            },
            
            handleSpreadCalculation(e) {
                e.preventDefault();
                const homeTeam = document.getElementById('homeTeam').value;
                const awayTeam = document.getElementById('awayTeam').value;
                const isNeutral = document.getElementById('neutralField').value === 'true';
                const resultDiv = document.getElementById('spreadResult');
                
                const homeData = this.data.ratings.find(t => t.team === homeTeam);
                const awayData = this.data.ratings.find(t => t.team === awayTeam);

                if (homeData && awayData) {
                    const homePR = parseFloat(homeData.power_rating || 0);
                    const awayPR = parseFloat(awayData.power_rating || 0);
                    let spread = homePR - awayPR + (isNeutral ? 0 : this.config.hfa);
                    spread = Math.round(spread * 2) / 2; // Round to nearest 0.5
                    
                    const favoredTeam = spread > 0 ? homeTeam : awayTeam;
                    resultDiv.innerHTML = `<strong>Predicted Spread:</strong> ${favoredTeam} -${Math.abs(spread)}`;
                } else {
                    resultDiv.innerHTML = '<strong>Error:</strong> Could not find data for one or both teams.';
                }
                resultDiv.style.display = 'block';
            },
            
            handleProbabilityCalculation(e) {
                e.preventDefault();
                const team1 = document.getElementById('probTeam1').value;
                const team2 = document.getElementById('probTeam2').value;
                const resultDiv = document.getElementById('probResult');
                
                const team1Data = this.data.ratings.find(t => t.team === team1);
                const team2Data = this.data.ratings.find(t => t.team === team2);

                if (team1Data && team2Data) {
                    const team1PR = parseFloat(team1Data.power_rating || 0);
                    const team2PR = parseFloat(team2Data.power_rating || 0);
                    const diff = (team1PR + this.config.hfa) - team2PR;
                    const prob = 1 / (1 + Math.pow(10, -diff * 0.04));
                    
                    resultDiv.innerHTML = `<strong>Win Probabilities:</strong><br>${team1}: ${(prob * 100).toFixed(1)}%<br>${team2}: ${((1 - prob) * 100).toFixed(1)}%`;
                } else {
                    resultDiv.innerHTML = '<strong>Error:</strong> Could not find team data.';
                }
                resultDiv.style.display = 'block';
            },

            handleHistorySearch(e) {
                e.preventDefault();
                const teamName = document.getElementById('historyTeam').value;
                const resultDiv = document.getElementById('historyResult');
                const team = this.data.teamData.find(row => row.team === teamName);

                if (team) {
                    resultDiv.innerHTML = `<strong>${teamName} - Week ${this.config.week} Stats:</strong><br>
                        Power Rating: ${parseFloat(team.power_rating || 0).toFixed(1)}<br>
                        Offensive Rank: ${team.offensive_rank || 'N/A'}<br>
                        Defensive Rank: ${team.defensive_rank || 'N/A'}<br>
                        SOS: ${parseFloat(team.SOS || 0).toFixed(1)}`;
                } else {
                    resultDiv.innerHTML = 'No data found for selected team.';
                }
                resultDiv.style.display = 'block';
            },

            // --- VISUALS ---
            setupVisuals() {
                // NOTE: Listing files from a directory is not possible in client-side JS.
                // You must manually list the available image files here.
                const gameFiles = ['AirForce_vs_Navy.png', 'BoiseState_vs_UtahState.png']; // Example
                const profileFiles = ['Top25_PEAR.png', 'Conference_Ratings.png']; // Example
                
                const gameSelect = document.getElementById('gameSelect');
                const profileSelect = document.getElementById('profileSelect');

                gameSelect.innerHTML = '<option value="">Select a game...</option>' + gameFiles.map(f => `<option value="${f}">${f.replace('.png', '').replace(/_/g, ' ')}</option>`).join('');
                profileSelect.innerHTML = '<option value="">Select a profile...</option>' + profileFiles.map(f => `<option value="${f}">${f.replace('.png', '').replace(/_/g, ' ')}</option>`).join('');
            },

            displayGameImage(e) {
                const container = document.getElementById('gameImageContainer');
                const fileName = e.target.value;
                if (fileName) {
                    const path = `PEAR/PEAR Football/y${this.config.year}/Visuals/week_${this.config.week}/Games/${fileName}`;
                    container.innerHTML = `<img src="${path}" alt="${fileName}" class="visual-image" onerror="this.parentElement.innerHTML='<div class=error>Image not found.</div>'">`;
                } else {
                    container.innerHTML = '';
                }
            },

            displayStatProfile(e) {
                const container = document.getElementById('profileImageContainer');
                const fileName = e.target.value;
                if (fileName) {
                    const path = `PEAR/PEAR Football/y${this.config.year}/Visuals/week_${this.config.week}/Stat Profiles/${fileName}`;
                    container.innerHTML = `<img src="${path}" alt="${fileName}" class="visual-image" onerror="this.parentElement.innerHTML='<div class=error>Image not found.</div>'">`;
                } else {
                    container.innerHTML = '';
                }
            },
            
            // --- UTILITY FUNCTIONS ---
            toggleLoading(elementId, show) {
                const el = document.getElementById(elementId);
                if (el) el.style.display = show ? 'block' : 'none';
            },

            showError(message) {
                const container = document.getElementById('globalErrorContainer');
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        };

        // Start the application once the DOM is ready.
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>