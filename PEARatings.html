<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEAR - College Football Power Ratings</title>
    <!-- External libraries for parsing data files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* General Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 50%;
            border: 3px solid #4ecdc4;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50px;
            padding: 5px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #fff;
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            margin: 2px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Tables */
        .data-table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Custom scrollbar styling */
        .data-table-container::-webkit-scrollbar {
            width: 12px;
        }

        .data-table-container::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.3);
            border-radius: 10px;
        }

        .data-table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 10px;
            border: 2px solid rgba(26, 26, 46, 0.3);
        }

        .data-table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #ff5252, #26a69a);
        }

        /* Firefox scrollbar */
        .data-table-container {
            scrollbar-width: thin;
            scrollbar-color: #4ecdc4 rgba(26, 26, 46, 0.3);
        }

        .download-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .download-btn {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Color-coded cells */
        .rating-cell {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }

        .rating-excellent { background: linear-gradient(135deg, #4a90e2, #357abd); color: white; }
        .rating-good { background: linear-gradient(135deg, #7cb342, #689f38); color: white; }
        .rating-average { background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; }
        .rating-poor { background: linear-gradient(135deg, #ef5350, #e53935); color: white; }
        .rating-neutral { background: linear-gradient(135deg, #9e9e9e, #757575); color: white; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(26, 26, 46, 0.95);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(78, 205, 196, 0.3);
        }

        th.sorted-asc::after {
            content: " â–²";
            color: #4ecdc4;
        }

        th.sorted-desc::after {
            content: " â–¼";
            color: #4ecdc4;
        }

        tbody tr:hover {
            background: rgba(78, 205, 196, 0.1);
        }

        /* Forms and Interactive Elements */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #4ecdc4; }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 1rem;
        }
        select option { background: #1a1a2e; color: #fff; }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        /* Layout */
        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        /* Utility Classes */
        .caption { font-size: 0.9rem; opacity: 0.7; margin-top: 10px; text-align: center; }
        .loading, .error { text-align: center; padding: 50px; font-size: 1.1rem; }
        .error { background: rgba(255, 107, 107, 0.2); border-left: 4px solid #ff6b6b; border-radius: 8px; margin: 20px 0; }
        .visual-image { max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            .nav-tabs { flex-direction: column; align-items: stretch; border-radius: 15px; }
            .tab-btn { margin: 2px 5px; text-align: center; }
            th, td { padding: 8px 5px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <img src="PEAR/pear_logo.jpg" alt="PEAR Logo" class="logo" onerror="this.style.display='none'">
            <h1>PEAR</h1>
            <p class="subtitle" id="weekDisplay">College Football Power Ratings</p>
        </header>
        
        <!-- Global Error Message Container -->
        <div id="globalErrorContainer"></div>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="power-ratings">Power Ratings</button>
            <button class="tab-btn" data-tab="spreads">Spreads</button>
            <button class="tab-btn" data-tab="visuals">Visuals</button>
        </nav>

        <!-- Power Ratings Tab -->
        <main id="power-ratings" class="tab-content active">
            <div class="card">
                <input type="text" id="teamSearch" placeholder="Search teams..." aria-label="Search teams">
            </div>
            <div class="download-section">
                <button class="download-btn" onclick="App.downloadCSV('ratings')">
                    ðŸ“Š Download CSV
                </button>
            </div>
            <div class="data-table-container">
                <div id="ratingsLoading" class="loading">Loading ratings data...</div>
                <table id="ratingsTable" style="display: none;">
                    <thead><tr id="ratingsHeader"></tr></thead>
                    <tbody id="ratingsBody"></tbody>
                </table>
            </div>
            <p class="caption">MD: Most Deserving | SOS: Strength of Schedule | SOR: Strength of Record | OFF: Offense | DEF: Defense</p>
        </main>

        <!-- Spreads Tab -->
        <main id="spreads" class="tab-content">
            <div class="two-column">
                <div>
                    <h2 id="spreadsTitle" class="subtitle" style="text-align: center; margin-bottom: 20px;">Weekly Spreads</h2>
                    <div class="download-section">
                        <button class="download-btn" onclick="App.downloadCSV('spreads')">
                            ðŸ“Š Download CSV
                        </button>
                    </div>
                    <div class="data-table-container">
                        <div id="spreadsLoading" class="loading">Loading spreads data...</div>
                        <table id="spreadsTable" style="display: none;">
                            <thead><tr id="spreadsHeader"></tr></thead>
                            <tbody id="spreadsBody"></tbody>
                        </table>
                    </div>
                    <p class="caption">GQI: Game Quality Index (Entertainment Value)</p>
                </div>
                <div class="card">
                    <h2>Spread Calculator</h2>
                    <form id="spreadForm">
                        <div class="form-group"><label for="awayTeam">Away Team</label><select id="awayTeam" required><option value="">Loading...</option></select></div>
                        <div class="form-group"><label for="homeTeam">Home Team</label><select id="homeTeam" required><option value="">Loading...</option></select></div>
                        <div class="form-group"><label for="neutralField">Location</label><select id="neutralField"><option value="false">On Campus</option><option value="true">Neutral Field</option></select></div>
                        <button type="submit" class="btn">Calculate Spread</button>
                    </form>
                    <div id="spreadResult" class="result" style="display: none;"></div>
                </div>
            </div>
        </main>

        <!-- Visuals Tab -->
        <main id="visuals" class="tab-content">
            <div class="two-column">
                <div class="card">
                    <h3>Game Images</h3>
                    <div class="form-group">
                        <label for="gameSelect">Select a Game:</label>
                        <select id="gameSelect"><option value="">Loading games...</option></select>
                    </div>
                    <div id="gameImageContainer"></div>
                </div>
                <div class="card">
                    <h3>Stat Profiles</h3>
                    <div class="form-group">
                        <label for="profileSelect">Select a Stat Profile:</label>
                        <select id="profileSelect"><option value="">Loading profiles...</option></select>
                    </div>
                    <div id="profileImageContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Main application logic
        const App = {
            // Store data and configuration here
            data: {
                ratings: [],
                spreads: [],
                teamData: [],
                teamsList: []
            },
            config: {
                year: 2025,
                week: 5,
                hfa: 3 // Home Field Advantage
            },

            // --- INITIALIZATION ---
            init() {
                this.addEventListeners();
                this.loadAllData();
                this.updateStaticUI();
            },

            addEventListeners() {
                // Tab navigation
                document.querySelector('.nav-tabs').addEventListener('click', this.handleTabClick.bind(this));
                
                // Interactive elements
                document.getElementById('teamSearch').addEventListener('keyup', this.handleTeamSearch.bind(this));
                document.getElementById('spreadForm').addEventListener('submit', this.handleSpreadCalculation.bind(this));

                // Visuals selectors
                document.getElementById('gameSelect').addEventListener('change', this.displayGameImage.bind(this));
                document.getElementById('profileSelect').addEventListener('change', this.displayStatProfile.bind(this));
            },
            
            updateStaticUI() {
                const { week, year } = this.config;
                document.getElementById('weekDisplay').textContent = `Week ${week} â€¢ ${year} Season`;
                document.getElementById('spreadsTitle').textContent = `Week ${week} Spreads`;
            },
            
            // --- DATA LOADING ---
            async fetchFile(path, type = 'csv') {
                try {
                    console.log(`Attempting to fetch: ${path}`);
                    const response = await fetch(path);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${path}. Status: ${response.status}`);
                    }
                    if (type === 'csv') {
                        const csvText = await response.text();
                        console.log(`CSV loaded, length: ${csvText.length} chars`);
                        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                        console.log(`Parsed ${parsed.data.length} rows`);
                        if (parsed.data.length > 0) {
                            console.log('Sample row:', parsed.data[0]);
                            console.log('Headers:', Object.keys(parsed.data[0]));
                        }
                        return parsed.data;
                    } else if (type === 'xlsx') {
                        const buffer = await response.arrayBuffer();
                        const workbook = XLSX.read(buffer, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        return XLSX.utils.sheet_to_json(sheet);
                    }
                } catch (error) {
                    console.error(error);
                    this.showError(`Could not load data from ${path}. Check the file path and that you are running a local server.`);
                    return null;
                }
            },

            async fetchDirectoryContents(dirPath) {
                try {
                    // Since we can't directly list directory contents in client-side JS,
                    // we'll try to fetch a directory index or use a predefined list
                    // This is a workaround - you may need to manually update these lists
                    
                    const gameFiles = ["Air Force vs Hawai'i.png",
                                    'Arizona State vs TCU.png',
                                    'Arkansas vs Notre Dame.png',
                                    'Boise State vs App State.png',
                                    'Boston College vs California.png',
                                    'Buffalo vs UConn.png',
                                    'Central Michigan vs Eastern Michigan.png',
                                    'Colorado State vs Washington State.png',
                                    'Colorado vs BYU.png',
                                    'East Carolina vs Army.png',
                                    'Florida Atlantic vs Memphis.png',
                                    'Georgia vs Alabama.png',
                                    'Illinois vs USC.png',
                                    'Iowa State vs Arizona.png',
                                    'Iowa vs Indiana.png',
                                    'James Madison vs Georgia Southern.png',
                                    'Kansas State vs UCF.png',
                                    'Kansas vs Cincinnati.png',
                                    'Kennesaw State vs Middle Tennessee.png',
                                    'Louisiana vs Marshall.png',
                                    'Minnesota vs Rutgers.png',
                                    'Mississippi State vs Tennessee.png',
                                    'Missouri State vs Western Kentucky.png',
                                    'Missouri vs Massachusetts.png',
                                    'NC State vs Virginia Tech.png',
                                    'Navy vs Rice.png',
                                    'New Mexico vs New Mexico State.png',
                                    'North Texas vs South Alabama.png',
                                    'Northern Illinois vs San Diego State.png',
                                    'Northwestern vs UCLA.png',
                                    'Ohio vs Bowling Green.png',
                                    'Oklahoma State vs Baylor.png',
                                    'Old Dominion vs Liberty.png',
                                    'Ole Miss vs LSU.png',
                                    'Oregon State vs Houston.png',
                                    'Penn State vs Oregon.png',
                                    'Pittsburgh vs Louisville.png',
                                    'South Carolina vs Kentucky.png',
                                    'Southern Miss vs Jacksonville State.png',
                                    'Stanford vs San JosÃ© State.png',
                                    'Syracuse vs Duke.png',
                                    'Texas A&M vs Auburn.png',
                                    'Toledo vs Akron.png',
                                    'Tulsa vs Tulane.png',
                                    'UL Monroe vs Arkansas State.png',
                                    'UTEP vs Louisiana Tech.png',
                                    'Vanderbilt vs Utah State.png',
                                    'Virginia vs Florida State.png',
                                    'Wake Forest vs Georgia Tech.png',
                                    'Washington vs Ohio State.png',
                                    'West Virginia vs Utah.png'];
                    const profileFiles = ['Air Force.png',
                                        'Akron.png',
                                        'Alabama.png',
                                        'App State.png',
                                        'Arizona State.png',
                                        'Arizona.png',
                                        'Arkansas State.png',
                                        'Arkansas.png',
                                        'Army.png',
                                        'Auburn.png',
                                        'BYU.png',
                                        'Ball State.png',
                                        'Baylor.png',
                                        'Boise State.png',
                                        'Boston College.png',
                                        'Bowling Green.png',
                                        'Buffalo.png',
                                        'California.png',
                                        'Central Michigan.png',
                                        'Charlotte.png',
                                        'Cincinnati.png',
                                        'Clemson.png',
                                        'Coastal Carolina.png',
                                        'Colorado State.png',
                                        'Colorado.png',
                                        'Delaware.png',
                                        'Duke.png',
                                        'East Carolina.png',
                                        'Eastern Michigan.png',
                                        'Florida Atlantic.png',
                                        'Florida International.png',
                                        'Florida State.png',
                                        'Florida.png',
                                        'Fresno State.png',
                                        'Georgia Southern.png',
                                        'Georgia State.png',
                                        'Georgia Tech.png',
                                        'Georgia.png',
                                        "Hawai'i.png",
                                        'Houston.png',
                                        'Illinois.png',
                                        'Indiana.png',
                                        'Iowa State.png',
                                        'Iowa.png',
                                        'Jacksonville State.png',
                                        'James Madison.png',
                                        'Kansas State.png',
                                        'Kansas.png',
                                        'Kennesaw State.png',
                                        'Kent State.png',
                                        'Kentucky.png',
                                        'LSU.png',
                                        'Liberty.png',
                                        'Louisiana Tech.png',
                                        'Louisiana.png',
                                        'Louisville.png',
                                        'Marshall.png',
                                        'Maryland.png',
                                        'Massachusetts.png',
                                        'Memphis.png',
                                        'Miami (OH).png',
                                        'Miami.png',
                                        'Michigan State.png',
                                        'Michigan.png',
                                        'Middle Tennessee.png',
                                        'Minnesota.png',
                                        'Mississippi State.png',
                                        'Missouri State.png',
                                        'Missouri.png',
                                        'NC State.png',
                                        'Navy.png',
                                        'Nebraska.png',
                                        'Nevada.png',
                                        'New Mexico State.png',
                                        'New Mexico.png',
                                        'North Carolina.png',
                                        'North Texas.png',
                                        'Northern Illinois.png',
                                        'Northwestern.png',
                                        'Notre Dame.png',
                                        'Ohio State.png',
                                        'Ohio.png',
                                        'Oklahoma State.png',
                                        'Oklahoma.png',
                                        'Old Dominion.png',
                                        'Ole Miss.png',
                                        'Oregon State.png',
                                        'Oregon.png',
                                        'Penn State.png',
                                        'Pittsburgh.png',
                                        'Purdue.png',
                                        'Rice.png',
                                        'Rutgers.png',
                                        'SMU.png',
                                        'Sam Houston.png',
                                        'San Diego State.png',
                                        'San JosÃ© State.png',
                                        'South Alabama.png',
                                        'South Carolina.png',
                                        'South Florida.png',
                                        'Southern Miss.png',
                                        'Stanford.png',
                                        'Syracuse.png',
                                        'TCU.png',
                                        'Temple.png',
                                        'Tennessee.png',
                                        'Texas A&M.png',
                                        'Texas State.png',
                                        'Texas Tech.png',
                                        'Texas.png',
                                        'Toledo.png',
                                        'Troy.png',
                                        'Tulane.png',
                                        'Tulsa.png',
                                        'UAB.png',
                                        'UCF.png',
                                        'UCLA.png',
                                        'UConn.png',
                                        'UL Monroe.png',
                                        'UNLV.png',
                                        'USC.png',
                                        'UTEP.png',
                                        'UTSA.png',
                                        'Utah State.png',
                                        'Utah.png',
                                        'Vanderbilt.png',
                                        'Virginia Tech.png',
                                        'Virginia.png',
                                        'Wake Forest.png',
                                        'Washington State.png',
                                        'Washington.png',
                                        'West Virginia.png',
                                        'Western Kentucky.png',
                                        'Western Michigan.png',
                                        'Wisconsin.png',
                                        'Wyoming.png'];
                    
                    // Return appropriate list based on directory path
                    if (dirPath.includes('Games')) {
                        return gameFiles;
                    } else if (dirPath.includes('Stat Profiles')) {
                        return profileFiles;
                    }
                    return [];
                } catch (error) {
                    console.error('Error fetching directory contents:', error);
                    return [];
                }
            },
            
            async loadAllData() {
                const { year, week } = this.config;
                const ratingsPath = `PEAR/PEAR Football/y${year}/Data/team_data_week${week}.csv`;
                const spreadsPath = `PEAR/PEAR Football/y${year}/Spreads/spreads_tracker_week${week}.xlsx`;

                const [ratings, spreads] = await Promise.all([
                    this.fetchFile(ratingsPath, 'csv'),
                    this.fetchFile(spreadsPath, 'xlsx')
                ]);

                // Process ratings data
                if (ratings) {
                    this.data.ratings = ratings;
                    this.data.teamsList = ratings.map(row => row.team).filter(Boolean).sort();
                    this.renderRatingsTable();
                    this.populateTeamSelectors();
                    this.addTableSorting('ratingsTable');
                }
                this.toggleLoading('ratingsLoading', false);

                // Process spreads data
                if (spreads) {
                    this.data.spreads = spreads;
                    this.renderSpreadsTable();
                    this.addTableSorting('spreadsTable');
                }
                this.toggleLoading('spreadsLoading', false);
                
                this.setupVisuals();
            },

            // --- RENDERING ---
            renderRatingsTable(filteredData = this.data.ratings) {
                const table = document.getElementById('ratingsTable');
                const header = document.getElementById('ratingsHeader');
                const body = document.getElementById('ratingsBody');
                
                if (filteredData.length === 0) {
                    table.style.display = 'none';
                    return;
                }
                
                // Debug logging to see actual field names
                const sampleRow = filteredData[0];
                console.log('=== DEBUGGING RATINGS DATA ===');
                console.log('Sample row:', sampleRow);
                console.log('All available keys:', Object.keys(sampleRow));
                console.log('Sample values:');
                Object.keys(sampleRow).forEach(key => {
                    console.log(`  ${key}: "${sampleRow[key]}"`);
                });
                
                header.innerHTML = `<th>Rank</th><th>Team</th><th>Rating</th><th>MD</th><th>SOS</th><th>SOR</th><th>OFF</th><th>DEF</th><th>CONF</th>`;
                body.innerHTML = filteredData.map((row, index) => {
                    // Let's try to be more flexible with field names and not convert to integers too aggressively
                    const getValue = (row, possibleFields) => {
                        for (let field of possibleFields) {
                            if (row[field] !== undefined && row[field] !== null && row[field] !== '') {
                                return row[field];
                            }
                        }
                        return '-';
                    };

                    const getNumericValue = (row, possibleFields, isFloat = false) => {
                        const value = getValue(row, possibleFields);
                        if (value === '-' || value === 'N/A' || value === null || value === undefined || value === '') {
                            return '-';
                        }
                        const num = isFloat ? parseFloat(value) : parseInt(value, 10);
                        if (isNaN(num)) {
                            return value; // Return original value if it's not a number
                        }
                        return isFloat ? num.toFixed(1) : num;
                    };

                    return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${getValue(row, ['team', 'Team'])}</td>
                        <td>${getNumericValue(row, ['power_rating', 'Rating'], true)}</td>
                        <td>${getValue(row, ['most_deserving', 'MD'])}</td>
                        <td>${getValue(row, ['SOS'], true)}</td>
                        <td>${getValue(row, ['SOR'], true)}</td>
                        <td>${getValue(row, ['Offense', 'OFF', 'offensive_rank'])}</td>
                        <td>${getValue(row, ['Defense', 'DEF', 'defensive_rank'])}</td>
                        <td>${getValue(row, ['conference', 'CONF'])}</td>
                    </tr>
                    `;
                }).join('');
                table.style.display = 'table';
            },

            renderSpreadsTable() {
                const table = document.getElementById('spreadsTable');
                const header = document.getElementById('spreadsHeader');
                const body = document.getElementById('spreadsBody');
                
                // Debug logging for spreads data
                if (this.data.spreads.length > 0) {
                    console.log('=== DEBUGGING SPREADS DATA ===');
                    console.log('Sample spreads row:', this.data.spreads[0]);
                    console.log('Spreads keys:', Object.keys(this.data.spreads[0]));
                }
                
                header.innerHTML = `<th>Home</th><th>Away</th><th>PEAR</th><th>Raw</th><th>Vegas</th><th>Diff</th><th>GQI</th>`;
                body.innerHTML = this.data.spreads.filter(row => row.home_team).map(row => `
                    <tr>
                        <td>${row.home_team || ''}</td>
                        <td>${row.away_team || ''}</td>
                        <td>${row.PEAR || ''}</td>
                        <td>${row.pr_spread || row.raw_spread || ''}</td>
                        <td>${row.Vegas || row.formattedSpread || ''}</td>
                        <td>${parseFloat(row.difference || 0).toFixed(1)}</td>
                        <td>${parseFloat(row.GQI || row.game_quality || 0).toFixed(1)}</td>
                    </tr>
                `).join('');
                table.style.display = 'table';
            },
            
            renderArchiveTable() {
                // Removed - Archive tab eliminated
            },

            populateTeamSelectors() {
                const options = `<option value="">Select Team</option>` + this.data.teamsList.map(team => `<option value="${team}">${team}</option>`).join('');
                ['awayTeam', 'homeTeam'].forEach(id => {
                    document.getElementById(id).innerHTML = options;
                });
            },

            // --- TABLE SORTING ---
            addTableSorting(tableId) {
                const table = document.getElementById(tableId);
                const headers = table.querySelectorAll('th');
                
                headers.forEach((header, index) => {
                    header.addEventListener('click', () => {
                        this.sortTable(table, index);
                    });
                });
            },

            sortTable(table, columnIndex) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const header = table.querySelector('th:nth-child(' + (columnIndex + 1) + ')');
                
                // Remove existing sort indicators
                table.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                // Determine sort direction
                const currentSort = header.dataset.sort || 'none';
                const newSort = currentSort === 'asc' ? 'desc' : 'asc';
                header.dataset.sort = newSort;
                header.classList.add(newSort === 'asc' ? 'sorted-asc' : 'sorted-desc');
                
                // Sort rows
                rows.sort((a, b) => {
                    const aVal = a.cells[columnIndex].textContent.trim();
                    const bVal = b.cells[columnIndex].textContent.trim();
                    
                    // Handle numeric values
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return newSort === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                    
                    // Handle text values
                    return newSort === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                });
                
                // Reattach sorted rows
                rows.forEach(row => tbody.appendChild(row));
            },

            // --- EVENT HANDLERS ---
            handleTabClick(event) {
                if (!event.target.matches('.tab-btn')) return;
                
                const tabName = event.target.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
            },

            handleTeamSearch(event) {
                const searchTerm = event.target.value.toLowerCase();
                const filtered = this.data.ratings.filter(row => (row.team || '').toLowerCase().includes(searchTerm));
                this.renderRatingsTable(filtered);
            },
            
            handleSpreadCalculation(e) {
                e.preventDefault();
                const homeTeam = document.getElementById('homeTeam').value;
                const awayTeam = document.getElementById('awayTeam').value;
                const isNeutral = document.getElementById('neutralField').value === 'true';
                const resultDiv = document.getElementById('spreadResult');
                
                const homeData = this.data.ratings.find(t => t.team === homeTeam);
                const awayData = this.data.ratings.find(t => t.team === awayTeam);

                if (homeData && awayData) {
                    const homePR = parseFloat(homeData.power_rating || homeData.Rating || 0);
                    const awayPR = parseFloat(awayData.power_rating || awayData.Rating || 0);
                    let spread = homePR - awayPR + (isNeutral ? 0 : this.config.hfa);
                    spread = Math.round(spread * 2) / 2; // Round to nearest 0.5
                    
                    const favoredTeam = spread > 0 ? homeTeam : awayTeam;
                    resultDiv.innerHTML = `<strong>Predicted Spread:</strong> ${favoredTeam} -${Math.abs(spread)}`;
                } else {
                    resultDiv.innerHTML = '<strong>Error:</strong> Could not find data for one or both teams.';
                }
                resultDiv.style.display = 'block';
            },

            handleHistorySearch(e) {
                // Removed - Archive functionality eliminated
            },

            // --- VISUALS ---
            async setupVisuals() {
                const { year, week } = this.config;
                const gamesDir = `PEAR/PEAR Football/y${year}/Visuals/week_${week}/Games`;
                const profilesDir = `PEAR/PEAR Football/y${year}/Visuals/week_${week}/Stat Profiles`;
                
                const gameFiles = await this.fetchDirectoryContents(gamesDir);
                const profileFiles = await this.fetchDirectoryContents(profilesDir);
                
                const gameSelect = document.getElementById('gameSelect');
                const profileSelect = document.getElementById('profileSelect');

                gameSelect.innerHTML = '<option value="">Select a game...</option>' + 
                    gameFiles.map(f => `<option value="${f}">${f.replace(/\.(png|jpg|jpeg)$/i, '').replace(/_/g, ' ')}</option>`).join('');
                
                profileSelect.innerHTML = '<option value="">Select a profile...</option>' + 
                    profileFiles.map(f => `<option value="${f}">${f.replace(/\.(png|jpg|jpeg)$/i, '').replace(/_/g, ' ')}</option>`).join('');
            },

            displayGameImage(e) {
                const container = document.getElementById('gameImageContainer');
                const fileName = e.target.value;
                if (fileName) {
                    const path = `PEAR/PEAR Football/y${this.config.year}/Visuals/week_${this.config.week}/Games/${fileName}`;
                    container.innerHTML = `<img src="${path}" alt="${fileName}" class="visual-image" onerror="this.parentElement.innerHTML='<div class=error>Image not found: ${fileName}</div>'">`;
                } else {
                    container.innerHTML = '';
                }
            },

            displayStatProfile(e) {
                const container = document.getElementById('profileImageContainer');
                const fileName = e.target.value;
                if (fileName) {
                    const path = `PEAR/PEAR Football/y${this.config.year}/Visuals/week_${this.config.week}/Stat Profiles/${fileName}`;
                    container.innerHTML = `<img src="${path}" alt="${fileName}" class="visual-image" onerror="this.parentElement.innerHTML='<div class=error>Image not found: ${fileName}</div>'">`;
                } else {
                    container.innerHTML = '';
                }
            },
            
            // --- UTILITY FUNCTIONS ---
            downloadCSV(type) {
                let data, filename, displayHeaders;
                
                if (type === 'ratings') {
                    data = this.data.ratings;
                    filename = `PEAR_Ratings_Week${this.config.week}_${this.config.year}.csv`;
                    // Only include the columns shown in the ratings table
                    displayHeaders = ['Rank', 'Team', 'Rating', 'MD', 'SOS', 'SOR', 'OFF', 'DEF', 'CONF'];
                } else if (type === 'spreads') {
                    data = this.data.spreads.filter(row => row.home_team);
                    filename = `PEAR_Spreads_Week${this.config.week}_${this.config.year}.csv`;
                    // Only include the columns shown in the spreads table
                    displayHeaders = ['Home', 'Away', 'PEAR', 'Raw', 'Vegas', 'Diff', 'GQI'];
                }
                
                if (!data || data.length === 0) {
                    alert('No data available to download');
                    return;
                }
                
                // Convert data to CSV format using only displayed columns
                let csvContent;
                
                if (type === 'ratings') {
                    const getValue = (row, possibleFields) => {
                        for (let field of possibleFields) {
                            if (row[field] !== undefined && row[field] !== null && row[field] !== '') {
                                return row[field];
                            }
                        }
                        return '-';
                    };

                    const getNumericValue = (row, possibleFields, isFloat = false) => {
                        const value = getValue(row, possibleFields);
                        if (value === '-' || value === 'N/A' || value === null || value === undefined || value === '') {
                            return '-';
                        }
                        const num = isFloat ? parseFloat(value) : parseInt(value, 10);
                        if (isNaN(num)) {
                            return value;
                        }
                        return isFloat ? num.toFixed(1) : num;
                    };

                    csvContent = [
                        displayHeaders.join(','),
                        ...data.map((row, index) => [
                            index + 1, // Rank
                            getValue(row, ['team', 'Team']),
                            getNumericValue(row, ['power_rating', 'Rating'], true),
                            getValue(row, ['most_deserving', 'MD']),
                            getValue(row, ['SOS'], true),
                            getValue(row, ['SOR'], true),
                            getValue(row, ['Offense', 'OFF', 'offensive_rank']),
                            getValue(row, ['Defense', 'DEF', 'defensive_rank']),
                            getValue(row, ['conference', 'CONF'])
                        ].map(value => {
                            // Escape commas and quotes in CSV
                            if (String(value).includes(',') || String(value).includes('"')) {
                                return `"${String(value).replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(','))
                    ].join('\n');
                    
                } else if (type === 'spreads') {
                    csvContent = [
                        displayHeaders.join(','),
                        ...data.map(row => [
                            row.home_team || '',
                            row.away_team || '',
                            row.PEAR || '',
                            row.pr_spread || row.raw_spread || '',
                            row.Vegas || row.formattedSpread || '',
                            parseFloat(row.difference || 0).toFixed(1),
                            parseFloat(row.GQI || row.game_quality || 0).toFixed(1)
                        ].map(value => {
                            // Escape commas and quotes in CSV
                            if (String(value).includes(',') || String(value).includes('"')) {
                                return `"${String(value).replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(','))
                    ].join('\n');
                }
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },

            toggleLoading(elementId, show) {
                const el = document.getElementById(elementId);
                if (el) el.style.display = show ? 'block' : 'none';
            },

            showError(message) {
                const container = document.getElementById('globalErrorContainer');
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        };

        // Start the application once the DOM is ready.
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>